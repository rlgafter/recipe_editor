{% extends "base.html" %}

{% block title %}Tag Management - Recipe Editor{% endblock %}

{% block extra_css %}
<style>
    .table thead th a {
        display: block;
        color: inherit;
        cursor: pointer;
    }
    .table thead th a:hover {
        color: #0d6efd;
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-tags"></i> Tag Management
            {% if is_admin_view %}
            <span class="badge bg-danger">Admin</span>
            {% endif %}
        </h1>
        
        <!-- Statistics Cards -->
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="card shadow-sm">
                    <div class="card-body text-center py-2 px-2">
                        <h6 class="mb-0">{{ total_tags }} Total Tags</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm border-primary">
                    <div class="card-body text-center py-2 px-2">
                        <h6 class="mb-0 text-primary">{{ system_tags }} System Tags</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm border-info">
                    <div class="card-body text-center py-2 px-2">
                        <h6 class="mb-0 text-info">{{ personal_tags }} Personal Tags</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm border-success">
                    <div class="card-body text-center py-2 px-2">
                        <h6 class="mb-0 text-success">{{ unique_personal_names }} Unique Names</h6>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="card shadow-sm mb-4">
            <div class="card-header header-dark-alt">
                <h5 class="mb-0"><i class="bi bi-funnel"></i> Filters</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('admin_tags') }}" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Search Tag Name</label>
                        <input type="text" class="form-control" name="search" 
                               value="{{ search }}" placeholder="Enter tag name...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tag Scope</label>
                        <select class="form-select" name="scope">
                            <option value="">All Scopes</option>
                            <option value="system" {% if scope_filter == 'system' %}selected{% endif %}>System</option>
                            <option value="personal" {% if scope_filter == 'personal' %}selected{% endif %}>Personal</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Owner User</label>
                        <select class="form-select" name="user">
                            <option value="">All Users</option>
                            {% for user in all_users %}
                            <option value="{{ user.id }}" {% if user_filter == user.id|string %}selected{% endif %}>
                                {{ user.username }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> Apply
                        </button>
                    </div>
                </form>
                {% if search or scope_filter or user_filter or sort_by != 'name' or sort_order != 'asc' %}
                <div class="mt-2">
                    <a href="{{ url_for('admin_tags') }}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> Clear All Filters & Sorting
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Tags Table -->
        <div class="card shadow-sm mb-4">
            <div class="card-header header-dark-alt d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-tags"></i> Tags ({{ total }})</h5>
                <div>
                    <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#createTagModal">
                        <i class="bi bi-plus-circle"></i> Create System Tag
                    </button>
                    <form method="POST" action="{{ url_for('admin_cleanup_tags') }}" style="display: inline;">
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Clean up all orphaned tags?')">
                            <i class="bi bi-trash"></i> Cleanup Orphaned
                        </button>
                    </form>
                </div>
            </div>
            <div class="card-body">
                {% if tags %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>
                                        <a href="?sort_by=name&sort_order={% if sort_by == 'name' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% if search %}&search={{ search }}{% endif %}{% if scope_filter %}&scope={{ scope_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}" 
                                           class="text-decoration-none text-dark">
                                            Tag Name 
                                            {% if sort_by == 'name' %}
                                                <i class="bi bi-arrow-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th>
                                        <a href="?sort_by=scope&sort_order={% if sort_by == 'scope' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% if search %}&search={{ search }}{% endif %}{% if scope_filter %}&scope={{ scope_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}" 
                                           class="text-decoration-none text-dark">
                                            Scope 
                                            {% if sort_by == 'scope' %}
                                                <i class="bi bi-arrow-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th>
                                        <a href="?sort_by=owner&sort_order={% if sort_by == 'owner' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% if search %}&search={{ search }}{% endif %}{% if scope_filter %}&scope={{ scope_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}" 
                                           class="text-decoration-none text-dark">
                                            Owner 
                                            {% if sort_by == 'owner' %}
                                                <i class="bi bi-arrow-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th class="text-center">
                                        <a href="?sort_by=recipes&sort_order={% if sort_by == 'recipes' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% if search %}&search={{ search }}{% endif %}{% if scope_filter %}&scope={{ scope_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}" 
                                           class="text-decoration-none text-dark">
                                            Recipes 
                                            {% if sort_by == 'recipes' %}
                                                <i class="bi bi-arrow-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tag in tags %}
                                    <tr>
                                        <td>
                                            <span class="badge {% if tag.tag_scope == 'system' %}bg-primary{% else %}bg-info{% endif %}">
                                                {{ tag.name }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if tag.tag_scope == 'system' %}
                                                <span class="badge bg-success">System</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Personal</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if tag.user %}
                                                {{ tag.user.username }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-secondary">{{ tag.recipe_count }}</span>
                                        </td>
                                        <td class="text-center">
                                            <button type="button" 
                                                    class="btn btn-sm btn-warning" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#editModal{{ tag.id }}">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            {% if tag.tag_scope == 'system' %}
                                                <button type="button" class="btn btn-sm btn-secondary" disabled
                                                        title="System tags cannot be deleted">
                                                    <i class="bi bi-lock"></i>
                                                </button>
                                            {% else %}
                                                <form method="POST" action="{{ url_for('admin_delete_tag', tag_id=tag.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm btn-danger" 
                                                            onclick="return confirm('Delete tag \'{{ tag.name }}\'? This will remove it from {{ tag.recipe_count }} recipe(s).')">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    
                                    <!-- Edit Modal -->
                                    <div class="modal fade" id="editModal{{ tag.id }}" tabindex="-1">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Edit Tag: {{ tag.name }}</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <form method="POST" action="{{ url_for('admin_edit_tag', tag_id=tag.id) }}">
                                                    <div class="modal-body">
                                                        <div class="mb-3">
                                                            <label class="form-label">Tag Name</label>
                                                            <input type="text" 
                                                                   class="form-control" 
                                                                   name="tag_name" 
                                                                   value="{{ tag.name }}"
                                                                   required>
                                                        </div>
                                                        <div class="alert alert-info">
                                                            <small>
                                                                <strong>Current:</strong> {{ tag.tag_scope|capitalize }} tag
                                                                {% if tag.user %} owned by {{ tag.user.username }}{% endif %}
                                                                with {{ tag.recipe_count }} recipe(s)
                                                            </small>
                                                        </div>
                                                        
                                                        {% if tag.tag_scope == 'system' %}
                                                        <div class="alert alert-success">
                                                            <i class="bi bi-shield-check"></i> <strong>System Tag:</strong> This tag is available to all users and cannot be deleted.
                                                        </div>
                                                        {% endif %}
                                                        
                                                        {% if tag.tag_scope == 'personal' %}
                                                        <div class="alert alert-warning">
                                                            <strong><i class="bi bi-arrow-up-circle"></i> Convert to System Tag:</strong>
                                                            <p class="mb-2 small">Convert all personal tags with this name (across all users) to a single system tag available to everyone.</p>
                                                            <button type="button" 
                                                                    class="btn btn-sm btn-warning" 
                                                                    data-bs-toggle="modal" 
                                                                    data-bs-target="#convertModal{{ tag.id }}"
                                                                    data-bs-dismiss="modal">
                                                                <i class="bi bi-arrow-up-circle"></i> Convert "{{ tag.name }}" to System
                                                            </button>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-primary">Save Changes</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {% if tag.tag_scope == 'personal' %}
                                    <!-- Convert to System Modal -->
                                    <div class="modal fade" id="convertModal{{ tag.id }}" tabindex="-1">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header bg-warning">
                                                    <h5 class="modal-title">Convert to System Tag</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <form method="POST" action="{{ url_for('admin_convert_tag_to_system') }}">
                                                    <input type="hidden" name="tag_name" value="{{ tag.name }}">
                                                    <div class="modal-body">
                                                        <div class="alert alert-warning">
                                                            <i class="bi bi-exclamation-triangle-fill"></i> <strong>Warning:</strong> This action cannot be undone!
                                                        </div>
                                                        <p><strong>Tag to convert:</strong> {{ tag.name }}</p>
                                                        <p><strong>Current owner:</strong> {{ tag.user.username if tag.user else 'N/A' }}</p>
                                                        <p><strong>Recipes using this tag:</strong> {{ tag.recipe_count }}</p>
                                                        
                                                        <hr>
                                                        
                                                        <p class="small">
                                                            This will find <strong>ALL</strong> personal tags named "{{ tag.name }}" 
                                                            (across all users) and merge them into a single system tag that will be 
                                                            available to everyone.
                                                        </p>
                                                        <p class="small text-muted">
                                                            All recipes currently using personal "{{ tag.name }}" tags will be updated 
                                                            to use the new system tag.
                                                        </p>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-warning">
                                                            <i class="bi bi-arrow-up-circle"></i> Convert to System Tag
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if pages > 1 %}
                    <nav aria-label="Tag pagination">
                        <ul class="pagination justify-content-center">
                            {% if page > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page - 1 }}{% if search %}&search={{ search }}{% endif %}{% if scope_filter %}&scope={{ scope_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">Previous</a>
                            </li>
                            {% endif %}
                            
                            {% for p in range(1, pages + 1) %}
                                {% if p == page %}
                                <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                                {% elif p <= 3 or p > pages - 3 or (p >= page - 1 and p <= page + 1) %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ p }}{% if search %}&search={{ search }}{% endif %}{% if scope_filter %}&scope={{ scope_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">{{ p }}</a>
                                </li>
                                {% elif p == 4 or p == pages - 3 %}
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if page < pages %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page + 1 }}{% if search %}&search={{ search }}{% endif %}{% if scope_filter %}&scope={{ scope_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">Next</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                {% else %}
                    <p class="text-muted text-center">No tags found matching your filters.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Back Button -->
        <div class="mb-4">
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Admin Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Create System Tag Modal -->
<div class="modal fade" id="createTagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create System Tag</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_create_tag') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tag Name</label>
                        <input type="text" class="form-control" name="tag_name" 
                               placeholder="Enter tag name" required>
                    </div>
                    <div class="alert alert-info mb-0">
                        <small>System tags are available to all users and can be used on any recipe.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Tag</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}
