{% extends "base_mysql.html" %}

{% block title %}Admin Panel{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar p-3">
            <div class="d-flex align-items-center mb-4">
                <i class="fas fa-tachometer-alt me-2"></i>
                <h5 class="mb-0">Admin Panel</h5>
            </div>
            
            <nav class="nav flex-column">
                <div class="nav-item">
                    <a class="nav-link active" href="{{ url_for('admin_users') }}">
                        <i class="fas fa-users me-2"></i>
                        Users
                    </a>
                    <div class="ms-4">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#addUserModal">
                            <i class="fas fa-plus me-2"></i>
                            Add User
                        </a>
                    </div>
                </div>
                <a class="nav-link" href="{{ url_for('recipe_list') }}" title="Manage all recipes">
                    <i class="fas fa-utensils me-2"></i>
                    Recipe Management
                </a>
                <a class="nav-link" href="{{ url_for('tag_manager') }}">
                    <i class="fas fa-tags me-2"></i>
                    Tags
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 main-content p-4">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-users"></i> User Management</h1>
                <div>
                    <span class="badge bg-primary">Administrator</span>
                </div>
            </div>


            <!-- Quick Stats -->
            <div class="row mb-4">
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card stats-card" style="background-color: transparent;">
                        <div class="card-body">
                            <div class="d-flex justify-content-start align-items-center">
                                <i class="fas fa-users fa-2x me-3"></i>
                                <span><strong>{{ total_users }}</strong> Total Users</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card stats-card" style="background-color: transparent;">
                        <div class="card-body">
                            <div class="d-flex justify-content-start align-items-center">
                                <i class="fas fa-user-check fa-2x me-3"></i>
                                <span><strong>{{ verified_users }}</strong> Verified Users</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card stats-card" style="background-color: transparent;">
                        <div class="card-body">
                            <div class="d-flex justify-content-start align-items-center">
                                <i class="fas fa-user fa-2x me-3"></i>
                                <span><strong>{{ active_users }}</strong> Active Users</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card stats-card" style="background-color: transparent;">
                        <div class="card-body">
                            <div class="d-flex justify-content-start align-items-center">
                                <i class="fas fa-user-shield fa-2x me-3"></i>
                                <span><strong>{{ admin_users }}</strong> Admins</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="search" 
                                   placeholder="Search by username, email, or display name..." 
                                   value="{{ search or '' }}">
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Users</h5>
                </div>
                <div class="card-body p-0">
                    {% if users %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th>Recipes</th>
                                    <th>Last Login</th>
                                    <th>Status</th>
                                    <th>Permissions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr id="user-row-{{ user.id }}" data-user-id="{{ user.id }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                {% if user.avatar_url %}
                                                <img src="{{ user.avatar_url }}" alt="Avatar" class="rounded-circle" width="40" height="40">
                                                {% else %}
                                                <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                    {{ user.username[0].upper() }}
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h6 class="mb-0">{{ user.display_name or user.username }}</h6>
                                                <small class="text-muted">{{ user.email }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="view-mode" id="role-view-{{ user.id }}">
                                            {% if user.is_admin %}
                                            <span class="badge bg-danger">Admin</span>
                                            {% else %}
                                            <span class="badge bg-primary">User</span>
                                            {% endif %}
                                        </div>
                                        <div class="edit-mode" id="role-edit-{{ user.id }}" style="display: none;">
                                            <select class="form-select form-select-sm" id="role-select-{{ user.id }}">
                                                <option value="0" {% if not user.is_admin %}selected{% endif %}>User</option>
                                                <option value="1" {% if user.is_admin %}selected{% endif %}>Admin</option>
                                            </select>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ user.recipe_count or 0 }}</span>
                                        {% if user.public_recipe_count > 0 %}
                                        <small class="text-muted">({{ user.public_recipe_count }} public)</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.last_login %}
                                        <small>{{ user.last_login.strftime('%Y-%m-%d %H:%M') }}</small>
                                        {% else %}
                                        <small class="text-muted">Never</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="view-mode" id="status-view-{{ user.id }}">
                                            {% if user.is_active %}
                                            <span class="badge bg-success">Active</span>
                                            {% else %}
                                            <span class="badge bg-danger">Inactive</span>
                                            {% endif %}
                                            {% if user.email_verified %}
                                            <span class="badge bg-info">Verified</span>
                                            {% endif %}
                                            {% if not user.account_setup_completed and user.password_setup_token %}
                                            <span class="badge bg-warning">Pending Setup</span>
                                            {% endif %}
                                        </div>
                                        <div class="edit-mode" id="status-edit-{{ user.id }}" style="display: none;">
                                            <div class="form-check form-check-sm mb-1">
                                                <input class="form-check-input" type="checkbox" id="status-active-{{ user.id }}" {% if user.is_active %}checked{% endif %}>
                                                <label class="form-check-label" for="status-active-{{ user.id }}">Active</label>
                                            </div>
                                            <div class="form-check form-check-sm mb-1">
                                                <input class="form-check-input" type="checkbox" id="status-verified-{{ user.id }}" {% if user.email_verified %}checked{% endif %}>
                                                <label class="form-check-label" for="status-verified-{{ user.id }}">Verified</label>
                                            </div>
                                            <div class="form-check form-check-sm">
                                                <input class="form-check-input" type="checkbox" id="status-setup-{{ user.id }}" {% if user.account_setup_completed %}checked{% endif %}>
                                                <label class="form-check-label" for="status-setup-{{ user.id }}">Setup Complete</label>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="view-mode" id="permissions-view-{{ user.id }}">
                                            {% if user.can_publish_public %}
                                            <span class="badge bg-success">Can Publish Public</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Standard</span>
                                            {% endif %}
                                        </div>
                                        <div class="edit-mode" id="permissions-edit-{{ user.id }}" style="display: none;">
                                            <div class="form-check form-check-sm">
                                                <input class="form-check-input" type="checkbox" id="permission-publish-{{ user.id }}" {% if user.can_publish_public %}checked{% endif %}>
                                                <label class="form-check-label" for="permission-publish-{{ user.id }}">Can Publish Public</label>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-primary" 
                                                    onclick="toggleEditMode({{ user.id }})"
                                                    id="edit-btn-{{ user.id }}"
                                                    title="Edit User">
                                                <i class="fas fa-edit me-1"></i>Edit
                                            </button>
                                            <button type="button" class="btn btn-success" 
                                                    onclick="saveUserChanges({{ user.id }})"
                                                    id="save-btn-{{ user.id }}"
                                                    style="display: none;"
                                                    title="Save Changes">
                                                <i class="fas fa-check me-1"></i>Save
                                            </button>
                                            <button type="button" class="btn btn-secondary" 
                                                    onclick="cancelEditMode({{ user.id }})"
                                                    id="cancel-btn-{{ user.id }}"
                                                    style="display: none;"
                                                    title="Cancel">
                                                <i class="fas fa-times me-1"></i>Cancel
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No users found</h5>
                        <p class="text-muted">Try adjusting your search criteria.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Pagination -->
            {% if pages > 1 %}
            <nav aria-label="User pagination" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page - 1 }}{% if search %}&search={{ search }}{% endif %}">Previous</a>
                    </li>
                    {% endif %}
                    
                    {% for p in range(1, pages + 1) %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                        <a class="page-link" href="?page={{ p }}{% if search %}&search={{ search }}{% endif %}">{{ p }}</a>
                    </li>
                    {% endfor %}
                    
                    {% if page < pages %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page + 1 }}{% if search %}&search={{ search }}{% endif %}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">
                    <i class="fas fa-user-plus me-2"></i>Add New User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addUserForm" method="POST" action="{{ url_for('admin_create_user') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="username" name="username" required>
                                <div class="form-text">Must be unique and 3-50 characters long</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="email" name="email" required>
                                <div class="form-text">Must be a valid email address</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>No password required!</strong> The user will receive a welcome email with a secure link to set their own password.
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="display_name" class="form-label">Display Name</label>
                                <input type="text" class="form-control" id="display_name" name="display_name">
                                <div class="form-text">Optional - shown instead of username</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="is_admin" name="is_admin" value="1">
                                    <label class="form-check-label" for="is_admin">
                                        Admin Privileges
                                    </label>
                                    <div class="form-text">Grant administrative access</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="email_verified" name="email_verified" value="1" checked>
                                    <label class="form-check-label" for="email_verified">
                                        Email Verified
                                    </label>
                                    <div class="form-text">Skip email verification</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-user-plus me-1"></i>Create User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.sidebar {
    min-height: calc(100vh - 56px);
    background-color: #f8f9fa;
    border-right: 1px solid #dee2e6;
}
.sidebar .nav-link {
    color: #495057;
    border-radius: 0.375rem;
    margin: 0.125rem 0;
    text-align: left;
}
.sidebar .nav-link:hover {
    background-color: #e9ecef;
    color: #0d6efd;
}
.sidebar .nav-link.active {
    background-color: #0d6efd;
    color: white;
}
.main-content {
    min-height: calc(100vh - 56px);
}
.stats-card {
    transition: transform 0.2s;
}
.stats-card:hover {
    transform: translateY(-2px);
}
.edit-mode .form-check {
    margin-bottom: 0.25rem;
}
.edit-mode .form-check-label {
    font-size: 0.875rem;
}
.btn-group-sm .btn {
    color: inherit;
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}
.btn-outline-primary {
    color: #0d6efd;
}
.btn-success {
    color: white;
    background-color: #198754;
    border-color: #198754;
}
.btn-secondary {
    color: white;
    background-color: #6c757d;
    border-color: #6c757d;
}
</style>

<script>
// Handle add user form submission
document.getElementById('addUserForm').addEventListener('submit', function(e) {
    console.log("=== FORM SUBMISSION DEBUG START ===");
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Debug form data
    console.log("Form data being submitted:");
    for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
    }
    
    console.log("Form action URL:", this.action);
    console.log("Submit button found:", submitBtn);
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating...';
    submitBtn.disabled = true;
    console.log("Button state changed to loading");
    
    fetch(this.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log("Response received:", response);
        console.log("Response status:", response.status);
        console.log("Response ok:", response.ok);
        
        if (response.ok) {
            console.log("Success - reloading page");
            // Success - reload page to show new user
            location.reload();
        } else {
            console.log("Error response - showing alert");
            // Error - show alert and reset button
            alert('Error creating user. Please check the form and try again.');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        console.error('Error details:', error.message);
        alert('An error occurred while creating the user');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
    
    console.log("=== FORM SUBMISSION DEBUG END ===");
});

// Store original values for cancel functionality
const originalValues = {};

function toggleEditMode(userId) {
    // Store original values
    originalValues[userId] = {
        role: document.getElementById(`role-select-${userId}`).value === '1',
        active: document.getElementById(`status-active-${userId}`).checked,
        verified: document.getElementById(`status-verified-${userId}`).checked,
        setup: document.getElementById(`status-setup-${userId}`).checked,
        publish: document.getElementById(`permission-publish-${userId}`).checked
    };
    
    // Toggle visibility
    document.getElementById(`role-view-${userId}`).style.display = 'none';
    document.getElementById(`role-edit-${userId}`).style.display = 'block';
    document.getElementById(`status-view-${userId}`).style.display = 'none';
    document.getElementById(`status-edit-${userId}`).style.display = 'block';
    document.getElementById(`permissions-view-${userId}`).style.display = 'none';
    document.getElementById(`permissions-edit-${userId}`).style.display = 'block';
    
    // Toggle buttons
    document.getElementById(`edit-btn-${userId}`).style.display = 'none';
    document.getElementById(`save-btn-${userId}`).style.display = 'inline-block';
    document.getElementById(`cancel-btn-${userId}`).style.display = 'inline-block';
}

function cancelEditMode(userId) {
    // Restore original values
    if (originalValues[userId]) {
        document.getElementById(`role-select-${userId}`).value = originalValues[userId].role ? '1' : '0';
        document.getElementById(`status-active-${userId}`).checked = originalValues[userId].active;
        document.getElementById(`status-verified-${userId}`).checked = originalValues[userId].verified;
        document.getElementById(`status-setup-${userId}`).checked = originalValues[userId].setup;
        document.getElementById(`permission-publish-${userId}`).checked = originalValues[userId].publish;
    }
    
    // Toggle visibility
    document.getElementById(`role-view-${userId}`).style.display = 'block';
    document.getElementById(`role-edit-${userId}`).style.display = 'none';
    document.getElementById(`status-view-${userId}`).style.display = 'block';
    document.getElementById(`status-edit-${userId}`).style.display = 'none';
    document.getElementById(`permissions-view-${userId}`).style.display = 'block';
    document.getElementById(`permissions-edit-${userId}`).style.display = 'none';
    
    // Toggle buttons
    document.getElementById(`edit-btn-${userId}`).style.display = 'inline-block';
    document.getElementById(`save-btn-${userId}`).style.display = 'none';
    document.getElementById(`cancel-btn-${userId}`).style.display = 'none';
    
    // Clean up stored values
    delete originalValues[userId];
}

function saveUserChanges(userId) {
    // Gather current values
    const roleValue = document.getElementById(`role-select-${userId}`).value === '1';
    const activeValue = document.getElementById(`status-active-${userId}`).checked;
    const verifiedValue = document.getElementById(`status-verified-${userId}`).checked;
    const setupValue = document.getElementById(`status-setup-${userId}`).checked;
    const publishValue = document.getElementById(`permission-publish-${userId}`).checked;
    
    // Check if anything changed
    const hasChanges = 
        originalValues[userId].role !== roleValue ||
        originalValues[userId].active !== activeValue ||
        originalValues[userId].verified !== verifiedValue ||
        originalValues[userId].setup !== setupValue ||
        originalValues[userId].publish !== publishValue;
    
    if (!hasChanges) {
        // No changes, just cancel edit mode
        cancelEditMode(userId);
        return;
    }
    
    // Confirm before saving
    if (!confirm('Are you sure you want to save these changes?')) {
        return;
    }
    
    // Prepare data
    const data = {
        user_id: userId,
        is_admin: roleValue,
        is_active: activeValue,
        email_verified: verifiedValue,
        account_setup_completed: setupValue,
        can_publish_public: publishValue
    };
    
    // Send update request
    fetch('{{ url_for("admin_update_user") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to refresh the page
            window.location.href = '{{ url_for("admin_users") }}';
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the user');
    });
}
</script>
{% endblock %}

